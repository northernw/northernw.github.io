<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="死磕！..  磕不动....那就..休息会儿再磕！"><title>Java序列化与反序列化 | northern</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java序列化与反序列化</h1><a id="logo" href="/.">northern</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Java序列化与反序列化</h1><div class="post-meta"><a href="/2020/06/20/Java序列化与反序列化/#comments" class="comment-count"></a><p><span class="date">Jun 20, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><p><strong>序列化与反序列化是成对存在的，文中简称为序列化。</strong></p>
<p>写在前面：</p>
<p>文中有很多源码，稍显凌乱。也主要是自己的一个记录，未字斟句酌。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><strong>序列化（serialize）</strong> - 序列化是将对象转换为字节流。</p>
<p><strong>反序列化（deserialize）</strong> - 反序列化是将字节流转换为对象。</p>
<p><strong>序列化用途</strong></p>
<ul>
<li>将对象持久化，保存在内存、文件、数据库中</li>
<li>便于网络传输和传播</li>
</ul>
<h1 id="序列化工具"><a href="#序列化工具" class="headerlink" title="序列化工具"></a>序列化工具</h1><p>java序列化 - 性能比较普通</p>
<p><a href="https://github.com/apache/thrift" target="_blank" rel="noopener">thrift</a>、<a href="https://github.com/protocolbuffers/protobuf" target="_blank" rel="noopener">protobuf</a> - 适用于对性能敏感，对开发体验要求不高的内部系统。</p>
<p><a href="http://hessian.caucho.com/doc/hessian-overview.xtp" target="_blank" rel="noopener">hessian</a> - 适用于对开发体验敏感，性能有要求的内外部系统。</p>
<p><a href="https://github.com/FasterXML/jackson" target="_blank" rel="noopener">jackson</a>、<a href="https://github.com/google/gson" target="_blank" rel="noopener">gson</a>、<a href="https://github.com/alibaba/fastjson" target="_blank" rel="noopener">fastjson</a> - 适用于对序列化后的数据要求有良好的可读性（转为 json 、xml 形式）。</p>
<h2 id="Java序列化"><a href="#Java序列化" class="headerlink" title="Java序列化"></a>Java序列化</h2><p>实现Serializable或Externalizable接口。</p>
<p>前者有默认序列化逻辑，后者需要强制实现自己的序列化逻辑。底层实现都是Serializable。</p>
<p>本文主要关注Serializable。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h4><p>实现Serializable接口，通过ObjectOutputStream来序列化，ObjectInputStream反序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6666716291353949192L</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setAge(<span class="number">22</span>);</span><br><span class="line">        person.setName(<span class="string">"lily"</span>);</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"java.person.txt"</span>));</span><br><span class="line">        objectOutputStream.writeObject(person);</span><br><span class="line">        log.info(<span class="string">"writeObject = &#123;&#125;"</span>, person);</span><br><span class="line"></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"java.person.txt"</span>));</span><br><span class="line">        person = (Person) objectInputStream.readObject();</span><br><span class="line">        log.info(<span class="string">"readObject = &#123;&#125;"</span>, person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">writeObject = Person(age=22, name=lily)</span><br><span class="line">readObject = Person(age=22, name=lily)</span><br></pre></td></tr></table></figure>
<h4 id="自定义用法"><a href="#自定义用法" class="headerlink" title="自定义用法"></a>自定义用法</h4><p>自定义序列化和反序列化逻辑，比如控制序列化字段、进行编码加密等。</p>
<p>在JavaBean中实现writeObject和readObject方法，方法签名是固定的。序列化过程中会判断JavaBean中的有无这样的方法，如果没有，就走入默认的defaultWriteFields和defaultReadFields的逻辑。</p>
<p>比如用age模拟加密和解密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ObjectOutputStream.PutField putFields = out.putFields();</span><br><span class="line">    putFields.put(<span class="string">"age"</span>, age + <span class="number">1</span>);</span><br><span class="line">    out.writeFields();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ObjectInputStream.GetField readFields = in.readFields();</span><br><span class="line">    Integer encryptionAge = (Integer) readFields.get(<span class="string">"age"</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="comment">// 模拟解密</span></span><br><span class="line">    age = encryptionAge - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其他知识点"><a href="#其他知识点" class="headerlink" title="其他知识点"></a>其他知识点</h4><ol>
<li><p>如果不实现Serializable接口，会抛出NotSerializableException异常。</p>
</li>
<li><p>如果属性是引用对象，引用对象也要实现序列化</p>
</li>
<li><p>一个子类实现Serializable 接口，父类也需要实现（否则父类信息不会被序列化）</p>
</li>
<li><p>静态字段不会参与序列化（序列化保存的是对象的状态，静态变量属于类的状态）</p>
</li>
<li><p>transient关键字修饰的对象不参与序列化</p>
</li>
<li><p>第二种自定义方式：writeReplace和readResolve</p>
<ol>
<li>writeObject 序列化时会调用 writeReplace 方法将当前对象替换成另一个对象并将其写入流中，此时如果有自定义的 writeObject 也不会生效了</li>
<li>readResolve 会在 readObject 调用之后自动调用，它最主要的目的就是对反序列化的对象进行修改后返回</li>
</ol>
</li>
<li><p>同一对象在一个ObjectOutputStream里writeObject多次，后面几次只会输出句柄信息</p>
</li>
<li><p><strong>潜在问题：</strong>如果在第一次序列化后，修改了内容，再次序列化时只会输出编码号，会丢失修改信息</p>
</li>
<li><p>serialVersionUID相当于类的版本号，如果没有显示定义serialVersionUID，编译期会根据类信息创建一个，当修改类后可能会引起反序列化失败（比如新增了字段，导致再次自动计算的serialVersionUID不相同）</p>
</li>
<li><p>serialVersionUID的idea快捷生成</p>
<p><img src="../../image/image-20200620173518028.png" alt="image-20200620173518028"></p>
</li>
</ol>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><h4 id="接口关系"><a href="#接口关系" class="headerlink" title="接口关系"></a>接口关系</h4><p>引用<a href="https://www.cnblogs.com/binarylei/p/10987933.html" target="_blank" rel="noopener">这里</a>一张接口关系图</p>
<p><img src="../../image/1322310-20190606081015449-98486965.png" alt="Java序列化接口"></p>
<ol>
<li><p><code>Serializable</code>和<code>Externalizable</code> 序列化接口</p>
<p>Serializable 接口没有方法或字段，仅用于标识可序列化的语义，实际上 ObjectOutputStream#writeObject 会判断JavaBean有没有自定义的writeObject 方法，如果没有则调用默认的序列化方法。</p>
<p>Externalizable 接口该接口中定义了两个扩展的抽象方法：writeExternal 与 readExternal。</p>
</li>
<li><p><code>DataOutput</code>和<code>ObjectOutput</code> </p>
<p>DataOutput 定义了对 8种Java 基本类型 byte、short、int、long、float、double、char、boolean，以及 String 的操作。</p>
<p>ObjectOutput 在 DataOutput 的基础上定义了对 Object 类型的操作。</p>
</li>
<li><p><code>ObjectOutputStream</code> </p>
<p>一般使用 ObjectOutputStream#writeObject 方法把一个对象进行持久化。（ObjectInputStream#readObject 则从持久化存储中把对象读取出来。）</p>
</li>
<li><p><code>ObjectStreamClass</code> 和 <code>ObjectStreamField</code> </p>
<p>ObjectStreamClass 是类的序列化描述符，包含类描述信息，字段的描述信息和 serialVersionUID。可以使用 lookup 方法找到创建在虚拟机中加载的具体类的 ObjectStreamClass。</p>
<p> ObjectStreamField 保存字段的序列化描述符，包括字段名、字段值等。</p>
</li>
</ol>
<h4 id="ObjectOutputStream源码分析"><a href="#ObjectOutputStream源码分析" class="headerlink" title="ObjectOutputStream源码分析"></a>ObjectOutputStream源码分析</h4><p>源码版本：jdk-12.0.1.jdk</p>
<h5 id="ObjectOutputStream-数据结构"><a href="#ObjectOutputStream-数据结构" class="headerlink" title="ObjectOutputStream 数据结构"></a>ObjectOutputStream 数据结构</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 输出流 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockDataOutputStream bout;</span><br><span class="line"><span class="comment">/** 句柄映射，如果在句柄中找到当前对象，说明已经序列化过，只输出句柄信息 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HandleTable handles;</span><br><span class="line"><span class="comment">/** 替换对象的映射 obj -&gt; replacement obj map */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReplaceTable subs; </span><br><span class="line"><span class="comment">/** true 则调用writeObjectOverride()来替代writeObject() -- ObjectOutputStream的子类可重写writeObjectOverride()*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> enableOverride;</span><br><span class="line"><span class="comment">/** true 则调用replaceObject() -- JavaBean中实现replaceObject() */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> enableReplace;</span><br></pre></td></tr></table></figure>
<h5 id="ObjectOutputStream-构造函数"><a href="#ObjectOutputStream-构造函数" class="headerlink" title="ObjectOutputStream 构造函数"></a>ObjectOutputStream 构造函数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 一些初试化 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ObjectOutputStream</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    verifySubclass();</span><br><span class="line">    bout = <span class="keyword">new</span> BlockDataOutputStream(out);</span><br><span class="line">    handles = <span class="keyword">new</span> HandleTable(<span class="number">10</span>, (<span class="keyword">float</span>) <span class="number">3.00</span>);</span><br><span class="line">    subs = <span class="keyword">new</span> ReplaceTable(<span class="number">10</span>, (<span class="keyword">float</span>) <span class="number">3.00</span>);</span><br><span class="line">    enableOverride = <span class="keyword">false</span>;</span><br><span class="line">    writeStreamHeader();</span><br><span class="line">    bout.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">        debugInfoStack = <span class="keyword">new</span> DebugTraceInfoStack();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        debugInfoStack = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  魔数和版本号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeStreamHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    bout.writeShort(STREAM_MAGIC);</span><br><span class="line">    bout.writeShort(STREAM_VERSION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="序列化入口-writeObject"><a href="#序列化入口-writeObject" class="headerlink" title="序列化入口 writeObject"></a>序列化入口 writeObject</h5><p>引用<a href="https://www.cnblogs.com/binarylei/p/10987933.html" target="_blank" rel="noopener">这里</a>一张时序图</p>
<p><img src="../../image/1322310-20190607214343020-892127930.png" alt="writeObject调用过程"></p>
<p>以下顺着基础用法的逻辑，看下代码实现。</p>
<h6 id="1-writeObject"><a href="#1-writeObject" class="headerlink" title="1. writeObject"></a>1. writeObject</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 如果当前是ObjectOutputStream的子类，走这个分支</span></span><br><span class="line">    <span class="keyword">if</span> (enableOverride) &#123;</span><br><span class="line">        writeObjectOverride(obj);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 核心方法</span></span><br><span class="line">        writeObject0(obj, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">            writeFatalException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-writeObject0"><a href="#2-writeObject0" class="headerlink" title="2. writeObject0"></a>2. writeObject0</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Underlying writeObject/writeUnshared implementation.</span></span><br><span class="line"><span class="comment"> * unshared=false表示共享对象，就是指同一个对象只输出句柄信息</span></span><br><span class="line"><span class="comment"> * unshared=true表示不共享，会完整再序列化一次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject0</span><span class="params">(Object obj, <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> oldMode = bout.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">  <span class="comment">// depth表示对象深度，比如当前对象为1，递归到对象属性时，depth++为2</span></span><br><span class="line">    depth++;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// handle previously written and non-replaceable objects</span></span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">      <span class="comment">// 判断要不要序列化 以下4种情况不用序列化</span></span><br><span class="line">        <span class="keyword">if</span> ((obj = subs.lookup(obj)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            writeNull();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (h = handles.lookup(obj)) != -<span class="number">1</span>) &#123; <span class="comment">// 是否共享已序列化对象，一般为是</span></span><br><span class="line">            writeHandle(h);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            writeClass((Class) obj, unshared);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">            writeClassDesc((ObjectStreamClass) obj, unshared);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check for replacement object</span></span><br><span class="line">      <span class="comment">// 这里处理对象替换，也先不看</span></span><br><span class="line">        Object orig = obj;</span><br><span class="line">      <span class="comment">// ps最后回来看: 怎么处理泛型呢？类信息写入的类型是java.lang.Object；写数据时，字段对应的类型是实际类型，比如java.lang.Integer这样的</span></span><br><span class="line">        Class&lt;?&gt; cl = obj.getClass();</span><br><span class="line">        ObjectStreamClass desc;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// REMIND: skip this check for strings/arrays?</span></span><br><span class="line">            Class&lt;?&gt; repCl;</span><br><span class="line">            desc = ObjectStreamClass.lookup(cl, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (!desc.hasWriteReplaceMethod() ||</span><br><span class="line">                (obj = desc.invokeWriteReplace(obj)) == <span class="keyword">null</span> ||</span><br><span class="line">                (repCl = obj.getClass()) == cl)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cl = repCl;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 如果对象替换了，取新对象的描述符</span></span><br><span class="line">        <span class="keyword">if</span> (enableReplace) &#123;</span><br><span class="line">            Object rep = replaceObject(obj);</span><br><span class="line">            <span class="keyword">if</span> (rep != obj &amp;&amp; rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cl = rep.getClass();</span><br><span class="line">                desc = ObjectStreamClass.lookup(cl, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            obj = rep;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果对象替换了，再判断一遍要不要序列化</span></span><br><span class="line">        <span class="keyword">if</span> (obj != orig) &#123;</span><br><span class="line">            subs.assign(orig, obj);</span><br><span class="line">            <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                writeNull();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (h = handles.lookup(obj)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                writeHandle(h);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">                writeClass((Class) obj, unshared);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">                writeClassDesc((ObjectStreamClass) obj, unshared);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化的主体逻辑在这里</span></span><br><span class="line">        <span class="comment">// 字符串和枚举在方法里写值进输出流了</span></span><br><span class="line">        <span class="comment">// 数组里的元素，如果是原生类型，也直接写输出流，如果非原生类型，递归序列化</span></span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123; <span class="comment">// 字符串</span></span><br><span class="line">            writeString((String) obj, unshared);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123; <span class="comment">// 数组</span></span><br><span class="line">            writeArray(obj, desc, unshared);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Enum) &#123; <span class="comment">// 枚举</span></span><br><span class="line">            writeEnum((Enum&lt;?&gt;) obj, desc, unshared);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Serializable) &#123; <span class="comment">// 实现了Serializable的JavaBean，也是我们要主要看的逻辑</span></span><br><span class="line">            writeOrdinaryObject(obj, desc, unshared);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不是以上几种情况的抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(</span><br><span class="line">                    cl.getName() + <span class="string">"\n"</span> + debugInfoStack.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(cl.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        depth--;</span><br><span class="line">        bout.setBlockDataMode(oldMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-1-writeString-amp-writeArray-amp-writeEnum"><a href="#2-1-writeString-amp-writeArray-amp-writeEnum" class="headerlink" title="2.1 writeString&amp;writeArray&amp;writeEnum"></a>2.1 writeString&amp;writeArray&amp;writeEnum</h6><p>字符串、枚举的在这里就写值了</p>
<p>数组元素如果是原生类型的，也写值了，如果非原生，递归调用writeObject0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Writes given string to stream, using standard or long UTF format</span></span><br><span class="line"><span class="comment"> * depending on string length.</span></span><br><span class="line"><span class="comment"> * UTF格式写string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeString</span><span class="params">(String str, <span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    handles.assign(unshared ? <span class="keyword">null</span> : str);</span><br><span class="line">    <span class="keyword">long</span> utflen = bout.getUTFLength(str);</span><br><span class="line">    <span class="keyword">if</span> (utflen &lt;= <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">        bout.writeByte(TC_STRING);</span><br><span class="line">        bout.writeUTF(str, utflen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bout.writeByte(TC_LONGSTRING);</span><br><span class="line">        bout.writeLongUTF(str, utflen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写数组</span></span><br><span class="line"><span class="comment"> * Writes given array object to stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeArray</span><span class="params">(Object array,</span></span></span><br><span class="line"><span class="function"><span class="params">                        ObjectStreamClass desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bout.writeByte(TC_ARRAY);</span><br><span class="line">    writeClassDesc(desc, <span class="keyword">false</span>);</span><br><span class="line">    handles.assign(unshared ? <span class="keyword">null</span> : array);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; ccl = desc.forClass().getComponentType();</span><br><span class="line">  <span class="comment">// 如果是原生类型的数组</span></span><br><span class="line">    <span class="keyword">if</span> (ccl.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ccl == Integer.TYPE) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] ia = (<span class="keyword">int</span>[]) array;</span><br><span class="line">            bout.writeInt(ia.length);</span><br><span class="line">            bout.writeInts(ia, <span class="number">0</span>, ia.length);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ... 省略其他原生类型 </span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object[] objs = (Object[]) array;</span><br><span class="line">        <span class="keyword">int</span> len = objs.length;</span><br><span class="line">      <span class="comment">// 写长度信息</span></span><br><span class="line">        bout.writeInt(len);</span><br><span class="line">        <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">            debugInfoStack.push(</span><br><span class="line">                <span class="string">"array (class \""</span> + array.getClass().getName() +</span><br><span class="line">                <span class="string">"\", size: "</span> + len  + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                    debugInfoStack.push(</span><br><span class="line">                        <span class="string">"element of array (index: "</span> + i + <span class="string">")"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 对每个对象序列化</span></span><br><span class="line">                    writeObject0(objs[i], <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                        debugInfoStack.pop();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                debugInfoStack.pop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Writes given enum constant to stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeEnum</span><span class="params">(Enum&lt;?&gt; en,</span></span></span><br><span class="line"><span class="function"><span class="params">                       ObjectStreamClass desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bout.writeByte(TC_ENUM);</span><br><span class="line">    ObjectStreamClass sdesc = desc.getSuperDesc();</span><br><span class="line">  <span class="comment">// 写枚举类信息</span></span><br><span class="line">    writeClassDesc((sdesc.forClass() == Enum.class) ? desc : sdesc, <span class="keyword">false</span>);</span><br><span class="line">    handles.assign(unshared ? <span class="keyword">null</span> : en);</span><br><span class="line">  <span class="comment">// 写枚举name</span></span><br><span class="line">    writeString(en.name(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-writeOrdinaryObject"><a href="#2-2-writeOrdinaryObject" class="headerlink" title="2.2 writeOrdinaryObject"></a>2.2 writeOrdinaryObject</h6><p>普通JavaBean的序列化逻辑</p>
<ol>
<li>写类型</li>
<li>写类信息</li>
<li>写类数据</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Writes representation of a "ordinary" (i.e., not a String, Class,</span></span><br><span class="line"><span class="comment"> * ObjectStreamClass, array, or enum constant) serializable object to the</span></span><br><span class="line"><span class="comment"> * stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeOrdinaryObject</span><span class="params">(Object obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ObjectStreamClass desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">        debugInfoStack.push(</span><br><span class="line">            (depth == <span class="number">1</span> ? <span class="string">"root "</span> : <span class="string">""</span>) + <span class="string">"object (class \""</span> +</span><br><span class="line">            obj.getClass().getName() + <span class="string">"\", "</span> + obj.toString() + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        desc.checkSerialize();</span><br><span class="line">      <span class="comment">// 写类型</span></span><br><span class="line">        bout.writeByte(TC_OBJECT);</span><br><span class="line">      <span class="comment">// 写类信息</span></span><br><span class="line">        writeClassDesc(desc, <span class="keyword">false</span>);</span><br><span class="line">        handles.assign(unshared ? <span class="keyword">null</span> : obj);</span><br><span class="line">      <span class="comment">// 写数据（Field信息和数据）</span></span><br><span class="line">        <span class="keyword">if</span> (desc.isExternalizable() &amp;&amp; !desc.isProxy()) &#123; <span class="comment">// Externalizable接口</span></span><br><span class="line">            writeExternalData((Externalizable) obj);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writeSerialData(obj, desc); <span class="comment">// Serializable接口</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">            debugInfoStack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-1-writeClassDesc"><a href="#2-2-1-writeClassDesc" class="headerlink" title="2.2.1 writeClassDesc"></a>2.2.1 writeClassDesc</h6><p>写类信息。</p>
<p>非代理类型的类信息，一般有类标志位、类名称、序列化协议版本、SUID、方法标志位、字段个数、然后每个字段的：字段TypeCode、字段名称、（非原生类型的）字段类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeClassDesc</span><span class="params">(ObjectStreamClass desc, <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> handle;</span><br><span class="line">        <span class="keyword">if</span> (desc == <span class="keyword">null</span>) &#123;</span><br><span class="line">            writeNull();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (handle = handles.lookup(desc)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            writeHandle(handle);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (desc.isProxy()) &#123;</span><br><span class="line">            writeProxyDesc(desc, unshared);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writeNonProxyDesc(desc, unshared);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Writes class descriptor representing a standard (i.e., not a dynamic</span></span><br><span class="line"><span class="comment">     * proxy) class to stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeNonProxyDesc</span><span class="params">(ObjectStreamClass desc, <span class="keyword">boolean</span> unshared)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        bout.writeByte(TC_CLASSDESC);</span><br><span class="line">        handles.assign(unshared ? <span class="keyword">null</span> : desc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (protocol == PROTOCOL_VERSION_1) &#123;</span><br><span class="line">            <span class="comment">// do not invoke class descriptor write hook with old protocol</span></span><br><span class="line">            desc.writeNonProxy(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writeClassDescriptor(desc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">        bout.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="keyword">null</span> &amp;&amp; isCustomSubclass()) &#123;</span><br><span class="line">            ReflectUtil.checkPackageAccess(cl);</span><br><span class="line">        &#125;</span><br><span class="line">        annotateClass(cl);</span><br><span class="line">        bout.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">        bout.writeByte(TC_ENDBLOCKDATA);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 往上递归，获取父类信息，直到父类没有实现Serializable</span></span><br><span class="line">        writeClassDesc(desc.getSuperDesc(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectStreamClass.java</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Writes non-proxy class descriptor information to given output stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeNonProxy</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.writeUTF(name);</span><br><span class="line">        out.writeLong(getSerialVersionUID());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span> flags = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (externalizable) &#123;</span><br><span class="line">            flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;</span><br><span class="line">            <span class="keyword">int</span> protocol = out.getProtocolVersion();</span><br><span class="line">            <span class="keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;</span><br><span class="line">                flags |= ObjectStreamConstants.SC_BLOCK_DATA;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (serializable) &#123;</span><br><span class="line">            flags |= ObjectStreamConstants.SC_SERIALIZABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasWriteObjectData) &#123;</span><br><span class="line">            flags |= ObjectStreamConstants.SC_WRITE_METHOD;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isEnum) &#123;</span><br><span class="line">            flags |= ObjectStreamConstants.SC_ENUM;</span><br><span class="line">        &#125;</span><br><span class="line">        out.writeByte(flags);</span><br><span class="line"></span><br><span class="line">        out.writeShort(fields.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            ObjectStreamField f = fields[i];</span><br><span class="line">            out.writeByte(f.getTypeCode());</span><br><span class="line">            out.writeUTF(f.getName());</span><br><span class="line">            <span class="keyword">if</span> (!f.isPrimitive()) &#123;</span><br><span class="line">                out.writeTypeString(f.getTypeString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-2-writeSerailData"><a href="#2-2-2-writeSerailData" class="headerlink" title="2.2.2 writeSerailData"></a>2.2.2 writeSerailData</h6><p>写类数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSerialData</span><span class="params">(Object obj, ObjectStreamClass desc)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 获取要序列化的对象</span></span><br><span class="line">    ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; slots.length; i++) &#123;</span><br><span class="line">        ObjectStreamClass slotDesc = slots[i].desc;</span><br><span class="line">      <span class="comment">// 如果对象中重写了writeObject</span></span><br><span class="line">        <span class="keyword">if</span> (slotDesc.hasWriteObjectMethod()) &#123;</span><br><span class="line">            PutFieldImpl oldPut = curPut;</span><br><span class="line">            curPut = <span class="keyword">null</span>;</span><br><span class="line">            SerialCallbackContext oldContext = curContext;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                debugInfoStack.push(</span><br><span class="line">                    <span class="string">"custom writeObject data (class \""</span> +</span><br><span class="line">                    slotDesc.getName() + <span class="string">"\")"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                curContext = <span class="keyword">new</span> SerialCallbackContext(obj, slotDesc);</span><br><span class="line">                bout.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">              <span class="comment">// 反射调用重写的writeObject</span></span><br><span class="line">                slotDesc.invokeWriteObject(obj, <span class="keyword">this</span>);</span><br><span class="line">                bout.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">                bout.writeByte(TC_ENDBLOCKDATA);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                curContext.setUsed();</span><br><span class="line">                curContext = oldContext;</span><br><span class="line">                <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                    debugInfoStack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            curPut = oldPut;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 默认的序列化方法</span></span><br><span class="line">            defaultWriteFields(obj, slotDesc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-2-1-defaultWriteFields"><a href="#2-2-2-1-defaultWriteFields" class="headerlink" title="2.2.2.1 defaultWriteFields"></a>2.2.2.1 defaultWriteFields</h6><p>真正写类数据的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fetches and writes values of serializable fields of given object to</span></span><br><span class="line"><span class="comment"> * stream.  The given class descriptor specifies which field values to</span></span><br><span class="line"><span class="comment"> * write, and in which order they should be written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defaultWriteFields</span><span class="params">(Object obj, ObjectStreamClass desc)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">    <span class="keyword">if</span> (cl != <span class="keyword">null</span> &amp;&amp; obj != <span class="keyword">null</span> &amp;&amp; !cl.isInstance(obj)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    desc.checkDefaultSerialize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取对象中原生类型的字段的总长度</span></span><br><span class="line">    <span class="keyword">int</span> primDataSize = desc.getPrimDataSize();</span><br><span class="line">    <span class="keyword">if</span> (primDataSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (primVals == <span class="keyword">null</span> || primVals.length &lt; primDataSize) &#123;</span><br><span class="line">            primVals = <span class="keyword">new</span> <span class="keyword">byte</span>[primDataSize];</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 获取对象中原生类型的字段的所有值，放入字节数组primVals</span></span><br><span class="line">      <span class="comment">// *这里是最终写对象里字段的值的地方*</span></span><br><span class="line">        desc.getPrimFieldValues(obj, primVals);</span><br><span class="line">      <span class="comment">// 将primVals写入输出流</span></span><br><span class="line">        bout.write(primVals, <span class="number">0</span>, primDataSize, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numObjFields = desc.getNumObjFields();</span><br><span class="line">    <span class="keyword">if</span> (numObjFields &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ObjectStreamField[] fields = desc.getFields(<span class="keyword">false</span>);</span><br><span class="line">        Object[] objVals = <span class="keyword">new</span> Object[numObjFields];</span><br><span class="line">      <span class="comment">// 剩下的非原生类型的字段</span></span><br><span class="line">        <span class="keyword">int</span> numPrimFields = fields.length - objVals.length;</span><br><span class="line">        desc.getObjFieldValues(obj, objVals);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objVals.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                debugInfoStack.push(</span><br><span class="line">                    <span class="string">"field (class \""</span> + desc.getName() + <span class="string">"\", name: \""</span> +</span><br><span class="line">                    fields[numPrimFields + i].getName() + <span class="string">"\", type: \""</span> +</span><br><span class="line">                    fields[numPrimFields + i].getType() + <span class="string">"\")"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 递归序列化这个非原生类型字段对象</span></span><br><span class="line">                writeObject0(objVals[i],</span><br><span class="line">                             fields[numPrimFields + i].isUnshared());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">                    debugInfoStack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这序列化的主体逻辑就结束了。</p>
<p>反序列化的主要操作和序列化都是一一对应的。读出每个类标志，用对应方式去解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readObject0</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> oldMode = bin.getBlockDataMode();</span><br><span class="line">    <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">        <span class="keyword">int</span> remain = bin.currentBlockRemaining();</span><br><span class="line">        <span class="keyword">if</span> (remain &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(remain);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultDataEnd) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Fix for 4360508: stream is currently at the end of a field</span></span><br><span class="line"><span class="comment">             * value block written via default serialization; since there</span></span><br><span class="line"><span class="comment">             * is no terminating TC_ENDBLOCKDATA tag, simulate</span></span><br><span class="line"><span class="comment">             * end-of-custom-data behavior explicitly.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里开始</span></span><br><span class="line">    <span class="keyword">byte</span> tc;</span><br><span class="line">    <span class="keyword">while</span> ((tc = bin.peekByte()) == TC_RESET) &#123;</span><br><span class="line">        bin.readByte();</span><br><span class="line">        handleReset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    depth++;</span><br><span class="line">    totalObjectRefs++;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">            <span class="keyword">case</span> TC_NULL:</span><br><span class="line">                <span class="keyword">return</span> readNull();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 共享的句柄索引</span></span><br><span class="line">            <span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">                <span class="keyword">return</span> readHandle(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_CLASS:</span><br><span class="line">                <span class="keyword">return</span> readClass(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类说明</span></span><br><span class="line">            <span class="keyword">case</span> TC_CLASSDESC:</span><br><span class="line">            <span class="keyword">case</span> TC_PROXYCLASSDESC:</span><br><span class="line">                <span class="keyword">return</span> readClassDesc(unshared);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符串</span></span><br><span class="line">            <span class="keyword">case</span> TC_STRING:</span><br><span class="line">            <span class="keyword">case</span> TC_LONGSTRING:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readString(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ARRAY:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readArray(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ENUM:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readEnum(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// JavaBean</span></span><br><span class="line">            <span class="keyword">case</span> TC_OBJECT:</span><br><span class="line">                <span class="keyword">return</span> checkResolve(readOrdinaryObject(unshared));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_EXCEPTION:</span><br><span class="line">                IOException ex = readFatalException();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WriteAbortedException(<span class="string">"writing aborted"</span>, ex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATA:</span><br><span class="line">            <span class="keyword">case</span> TC_BLOCKDATALONG:</span><br><span class="line">                <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">                    bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">                    bin.peek();             <span class="comment">// force header read</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(</span><br><span class="line">                        bin.currentBlockRemaining());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                        <span class="string">"unexpected block data"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TC_ENDBLOCKDATA:</span><br><span class="line">                <span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                        <span class="string">"unexpected end of block data"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">                    String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        depth--;</span><br><span class="line">        bin.setBlockDataMode(oldMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其他知识点-1"><a href="#其他知识点-1" class="headerlink" title="其他知识点"></a>其他知识点</h4><h6 id="字段值的读取和写入"><a href="#字段值的读取和写入" class="headerlink" title="字段值的读取和写入"></a>字段值的读取和写入</h6><p>ObjectOutputStream写值的逻辑：获取到当前对象中的原生类型字段，primDataSize是对象中所有原生类型字段的总长度，<code>desc.getPrimFieldValues(obj, primVals);</code>是将对象中的所有原生字段的值写入primVals这个字节数组，获取对象的值时是用Unsafe类直接通过偏移量取值，<code>unsafe.getBoolean(obj, offset)</code>这样的方式。</p>
<p>同理，ObjectInputStream读值的逻辑，<code>unsafe.putBoolean(obj, key, Bits.getBoolean(buf, off));</code></p>
<p>实现在<code>ObjectStreamClass#getPrimFieldValues</code>和<code>ObjectStreamClass#setPrimFieldValues</code></p>
<h6 id="共享句柄"><a href="#共享句柄" class="headerlink" title="共享句柄"></a>共享句柄</h6><p>序列化过程中出现过的对象、字符串、数值，甚至拼接出来的类信息，如果是shared模式，都不会再完整序列化一次，只会输出handles句柄的索引。</p>
<p><img src="../../image/image-20200621001054494.png" alt="image-20200621001054494"></p>
<p>写入句柄的地方</p>
<p><img src="../../image/image-20200621001613320.png" alt="image-20200621001613320"></p>
<h4 id="一个直观的例子"><a href="#一个直观的例子" class="headerlink" title="一个直观的例子"></a>一个直观的例子</h4><p>举上面Person的例子。</p>
<p>write Person: person -&gt; write Integer: age &amp; write String: name</p>
<p>write Integer: age -&gt; write int value(11) &amp; write Number : null</p>
<p>write String: name</p>
<p>Person里再加Birthday one, Birthday two属性。</p>
<p>Birthday属性 year, month, day.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6666716291353949192L</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Birthday one;</span><br><span class="line">    <span class="keyword">private</span> Birthday two;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Birthday</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Integer year;</span><br><span class="line">        <span class="keyword">private</span> Integer month;</span><br><span class="line">        <span class="keyword">private</span> Integer day;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setAge(<span class="number">22</span>);</span><br><span class="line">        person.setName(<span class="string">"lily"</span>);</span><br><span class="line"></span><br><span class="line">        Birthday one = <span class="keyword">new</span> Birthday();</span><br><span class="line">        one.setYear(<span class="number">2020</span>);</span><br><span class="line"></span><br><span class="line">        Birthday two = <span class="keyword">new</span> Birthday();</span><br><span class="line">        two.setYear(<span class="number">2019</span>);</span><br><span class="line">        person.setOne(one);</span><br><span class="line">        person.setTwo(two);</span><br><span class="line"><span class="comment">//        person.setIsParent(false);</span></span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"java.person.txt"</span>));</span><br><span class="line">        objectOutputStream.writeObject(person);</span><br><span class="line">        log.info(<span class="string">"writeObject = &#123;&#125;"</span>, person);</span><br><span class="line"></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"java.person.txt"</span>));</span><br><span class="line">        person = (Person) objectInputStream.readObject();</span><br><span class="line">        log.info(<span class="string">"readObject = &#123;&#125;"</span>, person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以JavaBean为例，不严谨的一份序列化结果接近这样：</p>
<p>魔数、版本号只在初始化写一次</p>
<p>魔数、版本号 | 类标志、类信息开始、类名称、序列化协议版本、SUID、一些序列信息标志（比如是Serializable还是externalizable..）、字段个数、（for每个字段的）字段TypeCode、字段名称、（非原生类型的）字段类型、类信息结束（向上递归父类的信息）【父类的类标志….（非原生类型的）字段类型、类信息结束】（从父类到子类，for每个类）所有原生字段的值+递归所有非原生字段的序列化</p>
<p><del>高亮那一段解释不来…</del>可以解释了，Birthday的fields如debug截图</p>
<p><img src="../../image/image-20200621002637015.png" alt="image-20200621002637015"></p>
<p><img src="../../image/image-20200621003459769.png" alt="image-20200621003459769"></p>
<h2 id="Gson"><a href="#Gson" class="headerlink" title="Gson"></a>Gson</h2><p>JSON (JavaScript Object Notation)是一种轻量级数据交换格式。</p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>依赖 maven</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="基础用法-1"><a href="#基础用法-1" class="headerlink" title="基础用法"></a>基础用法</h4><p>api非常的简单、易用</p>
<h5 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Serialization</span></span><br><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">gson.toJson(<span class="number">1</span>);            <span class="comment">// ==&gt; 1</span></span><br><span class="line">gson.toJson(<span class="string">"abcd"</span>);       <span class="comment">// ==&gt; "abcd"</span></span><br><span class="line">gson.toJson(<span class="keyword">new</span> Long(<span class="number">10</span>)); <span class="comment">// ==&gt; 10</span></span><br><span class="line"><span class="keyword">int</span>[] values = &#123; <span class="number">1</span> &#125;;</span><br><span class="line">gson.toJson(values);       <span class="comment">// ==&gt; [1]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Deserialization</span></span><br><span class="line"><span class="keyword">int</span> one = gson.fromJson(<span class="string">"1"</span>, <span class="keyword">int</span>.class);</span><br><span class="line">Integer one = gson.fromJson(<span class="string">"1"</span>, Integer.class);</span><br><span class="line">Long one = gson.fromJson(<span class="string">"1"</span>, Long.class);</span><br><span class="line">Boolean <span class="keyword">false</span> = gson.fromJson(<span class="string">"false"</span>, Boolean.class);</span><br><span class="line">String str = gson.fromJson(<span class="string">"\"abc\""</span>, String.class);</span><br><span class="line">String[] anotherStr = gson.fromJson(<span class="string">"[\"abc\"]"</span>, String[].class);</span><br></pre></td></tr></table></figure>
<h5 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BagOfPrimitives</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> value1 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">private</span> String value2 = <span class="string">"abc"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> value3 = <span class="number">3</span>;</span><br><span class="line">  BagOfPrimitives() &#123;</span><br><span class="line">    <span class="comment">// no-args constructor</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serialization</span></span><br><span class="line">BagOfPrimitives obj = <span class="keyword">new</span> BagOfPrimitives();</span><br><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">String json = gson.toJson(obj);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt; json is &#123;"value1":1,"value2":"abc"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Deserialization</span></span><br><span class="line">BagOfPrimitives obj2 = gson.fromJson(json, BagOfPrimitives.class);</span><br><span class="line"><span class="comment">// ==&gt; obj2 is just like obj</span></span><br></pre></td></tr></table></figure>
<h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"><span class="keyword">int</span>[] ints = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">String[] strings = &#123;<span class="string">"abc"</span>, <span class="string">"def"</span>, <span class="string">"ghi"</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serialization</span></span><br><span class="line">gson.toJson(ints);     <span class="comment">// ==&gt; [1,2,3,4,5]</span></span><br><span class="line">gson.toJson(strings);  <span class="comment">// ==&gt; ["abc", "def", "ghi"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Deserialization</span></span><br><span class="line"><span class="keyword">int</span>[] ints2 = gson.fromJson(<span class="string">"[1,2,3,4,5]"</span>, <span class="keyword">int</span>[].class); </span><br><span class="line"><span class="comment">// ==&gt; ints2 will be same as ints</span></span><br></pre></td></tr></table></figure>
<h5 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  T value;</span><br><span class="line">&#125;</span><br><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">Foo&lt;Bar&gt; foo = <span class="keyword">new</span> Foo&lt;Bar&gt;();</span><br><span class="line">gson.toJson(foo); <span class="comment">// May not serialize foo.value correctly</span></span><br><span class="line"></span><br><span class="line">gson.fromJson(json, foo.getClass()); <span class="comment">// foo.value 不能反序列化成 Bar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确反序列化泛型的方式 利用TypeToken</span></span><br><span class="line">Type fooType = <span class="keyword">new</span> TypeToken&lt;Foo&lt;Bar&gt;&gt;() &#123;&#125;.getType();</span><br><span class="line">gson.toJson(foo, fooType);</span><br><span class="line"></span><br><span class="line">gson.fromJson(json, fooType);</span><br></pre></td></tr></table></figure>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><h4 id="核心：TypeAdapter"><a href="#核心：TypeAdapter" class="headerlink" title="核心：TypeAdapter"></a>核心：TypeAdapter</h4><p>类型适配器，用到了适配器模式，作为JsonWriter/JsonReader和类型T的对象之间的适配器，将一个对象写入json数据，或从json数据中读入一个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAdapter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Gson为每一种类型创建一个TypeAdapter，同样的，每一个Type都对应唯一一个TypeAdapter。</p>
<p>在Gson中，类型Type大致可以分为两类：</p>
<ol>
<li>基本平台类型，如int.class、Integer.class、String.class、Url.class等</li>
<li>组合及自定义类型，如Collection.class、Map.class和用户自定义的JavaBean等</li>
</ol>
<p>引用<a href="https://juejin.im/post/5c1473d9e51d4529ee23645f#heading-2" target="_blank" rel="noopener">这里</a>一张示意图：</p>
<p>Gson根据传入的Type找对应的TypeAdapter，如果是基本平台类型，利用TypeAdapter可直接读写json，如果是组合及自定义类型，则在对应的TypeAdapter里封装了对内部属性的处理，是一个迭代的过程（和上面Java自带的序列化writeOrdinaryObject&amp;readOrdinaryObject是很类似的）。</p>
<p><img src="../../image/image-20200622204756920.png" alt="image-20200622204756920"></p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><h5 id="Gson属性和构造函数"><a href="#Gson属性和构造函数" class="headerlink" title="Gson属性和构造函数"></a>Gson属性和构造函数</h5><p>一些属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 避免获取adapter的时候产生无限递归</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt;&gt; calls</span><br><span class="line">      = <span class="keyword">new</span> ThreadLocal&lt;Map&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt;&gt;();</span><br><span class="line"><span class="comment">// 缓存的adapter</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;TypeToken&lt;?&gt;, TypeAdapter&lt;?&gt;&gt; typeTokenCache = <span class="keyword">new</span> ConcurrentHashMap&lt;TypeToken&lt;?&gt;, TypeAdapter&lt;?&gt;&gt;();</span><br><span class="line"><span class="comment">// 注册的adapter工厂</span></span><br><span class="line"><span class="keyword">final</span> List&lt;TypeAdapterFactory&gt; factories;</span><br></pre></td></tr></table></figure>
<p>最终调用的构造函数</p>
<p><code>new Gson()</code>得到默认的实例，或者用<code>GsonBuilder</code>自定义一些策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Gson(Excluder excluder, FieldNamingStrategy fieldNamingStrategy,</span><br><span class="line">      Map&lt;Type, InstanceCreator&lt;?&gt;&gt; instanceCreators, <span class="keyword">boolean</span> serializeNulls,</span><br><span class="line">      <span class="keyword">boolean</span> complexMapKeySerialization, <span class="keyword">boolean</span> generateNonExecutableGson, <span class="keyword">boolean</span> htmlSafe,</span><br><span class="line">      <span class="keyword">boolean</span> prettyPrinting, <span class="keyword">boolean</span> lenient, <span class="keyword">boolean</span> serializeSpecialFloatingPointValues,</span><br><span class="line">      LongSerializationPolicy longSerializationPolicy, String datePattern, <span class="keyword">int</span> dateStyle,</span><br><span class="line">      <span class="keyword">int</span> timeStyle, List&lt;TypeAdapterFactory&gt; builderFactories,</span><br><span class="line">      List&lt;TypeAdapterFactory&gt; builderHierarchyFactories,</span><br><span class="line">      List&lt;TypeAdapterFactory&gt; factoriesToBeAdded) &#123;</span><br><span class="line">  <span class="comment">// 默认的一些序列化策略，比如字段名称策略，自定义的实例化构造器，pretty输出...</span></span><br><span class="line">    <span class="keyword">this</span>.excluder = excluder;</span><br><span class="line">    <span class="keyword">this</span>.fieldNamingStrategy = fieldNamingStrategy;</span><br><span class="line">    <span class="keyword">this</span>.instanceCreators = instanceCreators;</span><br><span class="line">    <span class="keyword">this</span>.constructorConstructor = <span class="keyword">new</span> ConstructorConstructor(instanceCreators);</span><br><span class="line">    <span class="keyword">this</span>.serializeNulls = serializeNulls;</span><br><span class="line">    <span class="keyword">this</span>.complexMapKeySerialization = complexMapKeySerialization;</span><br><span class="line">    <span class="keyword">this</span>.generateNonExecutableJson = generateNonExecutableGson;</span><br><span class="line">    <span class="keyword">this</span>.htmlSafe = htmlSafe;</span><br><span class="line">    <span class="keyword">this</span>.prettyPrinting = prettyPrinting;</span><br><span class="line">    <span class="keyword">this</span>.lenient = lenient;</span><br><span class="line">    <span class="keyword">this</span>.serializeSpecialFloatingPointValues = serializeSpecialFloatingPointValues;</span><br><span class="line">    <span class="keyword">this</span>.longSerializationPolicy = longSerializationPolicy;</span><br><span class="line">    <span class="keyword">this</span>.datePattern = datePattern;</span><br><span class="line">    <span class="keyword">this</span>.dateStyle = dateStyle;</span><br><span class="line">    <span class="keyword">this</span>.timeStyle = timeStyle;</span><br><span class="line">    <span class="keyword">this</span>.builderFactories = builderFactories;</span><br><span class="line">    <span class="keyword">this</span>.builderHierarchyFactories = builderHierarchyFactories;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册adapter工厂</span></span><br><span class="line">    List&lt;TypeAdapterFactory&gt; factories = <span class="keyword">new</span> ArrayList&lt;TypeAdapterFactory&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// built-in type adapters that cannot be overridden</span></span><br><span class="line">    factories.add(TypeAdapters.JSON_ELEMENT_FACTORY);</span><br><span class="line">    factories.add(ObjectTypeAdapter.FACTORY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the excluder must precede all adapters that handle user-defined types</span></span><br><span class="line">    factories.add(excluder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// users' type adapters 如果有自定义的工厂，在这里被加入，顺序比较靠前</span></span><br><span class="line">    factories.addAll(factoriesToBeAdded);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// type adapters for basic platform types 基本平台类型的adapter工厂</span></span><br><span class="line">    factories.add(TypeAdapters.STRING_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.INTEGER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.BOOLEAN_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.BYTE_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.SHORT_FACTORY);</span><br><span class="line">    TypeAdapter&lt;Number&gt; longAdapter = longAdapter(longSerializationPolicy);</span><br><span class="line">    factories.add(TypeAdapters.newFactory(<span class="keyword">long</span>.class, Long.class, longAdapter));</span><br><span class="line">    factories.add(TypeAdapters.newFactory(<span class="keyword">double</span>.class, Double.class,</span><br><span class="line">            doubleAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">    factories.add(TypeAdapters.newFactory(<span class="keyword">float</span>.class, Float.class,</span><br><span class="line">            floatAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">    factories.add(TypeAdapters.NUMBER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.ATOMIC_INTEGER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.ATOMIC_BOOLEAN_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.newFactory(AtomicLong.class, atomicLongAdapter(longAdapter)));</span><br><span class="line">    factories.add(TypeAdapters.newFactory(AtomicLongArray.class, atomicLongArrayAdapter(longAdapter)));</span><br><span class="line">    factories.add(TypeAdapters.ATOMIC_INTEGER_ARRAY_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.CHARACTER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.STRING_BUILDER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.STRING_BUFFER_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.newFactory(BigDecimal.class, TypeAdapters.BIG_DECIMAL));</span><br><span class="line">    factories.add(TypeAdapters.newFactory(BigInteger.class, TypeAdapters.BIG_INTEGER));</span><br><span class="line">    factories.add(TypeAdapters.URL_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.URI_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.UUID_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.CURRENCY_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.LOCALE_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.INET_ADDRESS_FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.BIT_SET_FACTORY);</span><br><span class="line">    factories.add(DateTypeAdapter.FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.CALENDAR_FACTORY);</span><br><span class="line">    factories.add(TimeTypeAdapter.FACTORY);</span><br><span class="line">    factories.add(SqlDateTypeAdapter.FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.TIMESTAMP_FACTORY);</span><br><span class="line">    factories.add(ArrayTypeAdapter.FACTORY);</span><br><span class="line">    factories.add(TypeAdapters.CLASS_FACTORY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// type adapters for composite and user-defined types 复合类型和自定义类型的adapter工厂</span></span><br><span class="line">    factories.add(<span class="keyword">new</span> CollectionTypeAdapterFactory(constructorConstructor));</span><br><span class="line">    factories.add(<span class="keyword">new</span> MapTypeAdapterFactory(constructorConstructor, complexMapKeySerialization));</span><br><span class="line">    <span class="keyword">this</span>.jsonAdapterFactory = <span class="keyword">new</span> JsonAdapterAnnotationTypeAdapterFactory(constructorConstructor);</span><br><span class="line">    factories.add(jsonAdapterFactory);</span><br><span class="line">    factories.add(TypeAdapters.ENUM_FACTORY);</span><br><span class="line">    factories.add(<span class="keyword">new</span> ReflectiveTypeAdapterFactory(</span><br><span class="line">        constructorConstructor, fieldNamingStrategy, excluder, jsonAdapterFactory));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.factories = Collections.unmodifiableList(factories);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h5 id="toJson"><a href="#toJson" class="headerlink" title="toJson"></a>toJson</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LearningGsonTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setAge(<span class="number">22</span>);</span><br><span class="line">        person.setName(<span class="string">"lily"</span>);</span><br><span class="line">        log.info(<span class="string">"person = &#123;&#125;"</span>, person);</span><br><span class="line"></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        String json = gson.toJson(person);</span><br><span class="line">        log.info(<span class="string">"json = &#123;&#125;"</span>, json);</span><br><span class="line"></span><br><span class="line">        person = gson.fromJson(json, Person.class);</span><br><span class="line">        log.info(<span class="string">"person = &#123;&#125;"</span>, person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toJson</span><span class="params">(Object src)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (src == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> toJson(JsonNull.INSTANCE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取Object的Type</span></span><br><span class="line">    <span class="comment">// Class.class属于Type的一种</span></span><br><span class="line">    <span class="keyword">return</span> toJson(src, src.getClass());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc)</span> </span>&#123;</span><br><span class="line">    StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    toJson(src, typeOfSrc, writer);</span><br><span class="line">    <span class="keyword">return</span> writer.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc, Appendable writer)</span> <span class="keyword">throws</span> JsonIOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      JsonWriter jsonWriter = newJsonWriter(Streams.writerForAppendable(writer));</span><br><span class="line">      toJson(src, typeOfSrc, jsonWriter);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终都会到这个方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc, JsonWriter writer)</span> <span class="keyword">throws</span> JsonIOException </span>&#123;</span><br><span class="line">    <span class="comment">// 关键步骤1，获取到对应的TypeAdapter</span></span><br><span class="line">    TypeAdapter&lt;?&gt; adapter = getAdapter(TypeToken.get(typeOfSrc));</span><br><span class="line">    <span class="keyword">boolean</span> oldLenient = writer.isLenient();</span><br><span class="line">    writer.setLenient(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">boolean</span> oldHtmlSafe = writer.isHtmlSafe();</span><br><span class="line">    writer.setHtmlSafe(htmlSafe);</span><br><span class="line">    <span class="keyword">boolean</span> oldSerializeNulls = writer.getSerializeNulls();</span><br><span class="line">    writer.setSerializeNulls(serializeNulls);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 关键步骤2，利用TypeAdapter写出json数据</span></span><br><span class="line">      ((TypeAdapter&lt;Object&gt;) adapter).write(writer, src);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AssertionError e) &#123;</span><br><span class="line">      AssertionError error = <span class="keyword">new</span> AssertionError(<span class="string">"AssertionError (GSON "</span> + GsonBuildConfig.VERSION + <span class="string">"): "</span> + e.getMessage());</span><br><span class="line">      error.initCause(e);</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      writer.setLenient(oldLenient);</span><br><span class="line">      writer.setHtmlSafe(oldHtmlSafe);</span><br><span class="line">      writer.setSerializeNulls(oldSerializeNulls);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>看一下<code>TypeToken.get(typeOfSrc)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets type literal for the given &#123;<span class="doctag">@code</span> Type&#125; instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TypeToken&lt;?&gt; get(Type type) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> TypeToken&lt;Object&gt;(type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Unsafe. Constructs a type literal manually.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">TypeToken(Type type) &#123;</span><br><span class="line">  <span class="comment">// 带泛型信息的类型</span></span><br><span class="line">  <span class="keyword">this</span>.type = $Gson$Types.canonicalize($Gson$Preconditions.checkNotNull(type));</span><br><span class="line">  <span class="comment">// 泛型擦除的类型，比如List.class</span></span><br><span class="line">  <span class="keyword">this</span>.rawType = (Class&lt;? <span class="keyword">super</span> T&gt;) $Gson$Types.getRawType(<span class="keyword">this</span>.type);</span><br><span class="line">  <span class="keyword">this</span>.hashCode = <span class="keyword">this</span>.type.hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>穿插一下Java类型（Type）系统的介绍。</p>
<p>详细内容可以看这两篇文章Java中的Type类型详解](<a href="https://juejin.im/post/5adefaba518825670e5cb44d)和[Java" target="_blank" rel="noopener">https://juejin.im/post/5adefaba518825670e5cb44d)和[Java</a> Type类型](<a href="https://www.jianshu.com/p/39cc237ad815)，或者Google下。" target="_blank" rel="noopener">https://www.jianshu.com/p/39cc237ad815)，或者Google下。</a></p>
<p>简单说明下</p>
<ol>
<li>Type是Java语言中所有类型的公共父接口，有4个扩展接口，主要是用来记录泛型的信息（一个泛型中的信息可能是另一个泛型）<ol>
<li>GenericArrayType：泛型数组类型，比如<code>T[] array</code>、<code>List&lt;String&gt;[] array</code>中的<code>T[]</code>、<code>List&lt;String&gt;[]</code></li>
<li>ParameterizedType：参数化类型，比如<code>Lis&lt;String&gt; list</code>、<code>Map&lt;String,Object&gt; map</code>中的<code>Lis&lt;String&gt;</code>、<code>Map&lt;String,Object&gt;</code></li>
<li>TypeVariable：类型变量，比如<code>List&lt;T&gt; list</code>中的<code>T</code>、<code>Map&lt;K,V&gt; map</code>、<code>E[] array</code>中的<code>K</code>、<code>V</code>、<code>E</code>（一般外层还有一个GenericArrayType或者ParameterizedType）</li>
<li>WildcardType：通配符类型，比如<code>Map&lt;? extends A,? super B&gt; map</code>中的<code>? extends A</code>、<code>? super B</code>，<code>A</code>称为上界，<code>B</code>称为下界；如果只有<code>List&lt;?&gt; list</code>，默认下界是String，默认上界是Object</li>
</ol>
</li>
<li>Class是Type的一个直接实现类</li>
<li>其他4个接口都有自己的实现类，在sun.reflect包下</li>
</ol>
<p><img src="../../image/image-20200624164140296.png" alt="image-20200624164140296"></p>
<p>举例子：</p>
<p>比如<code>List&lt;T extends Map&gt;[] array</code>是一个泛型数组类型GenericArrayType，其中<code>List&lt;T&gt;</code>是ParameterizedType，<code>T</code>是TypeVariable</p>
<p>genericComponentType可以理解为数组中每个元素的（泛型）类型</p>
<p><img src="../../image/image-20200624174833587.png" alt="image-20200624174833587"></p>
<p>再如<code>List&lt;? extends Map&gt; list</code>，本身是一个ParameterizedType，<code>? extends Map</code>是WildcardType</p>
<p><img src="../../image/image-20200624175245701.png" alt="image-20200624175245701"></p>
<p><code>T[] array</code>，本身是GenericArrayType，<code>T</code>是TypeVariable</p>
<p><img src="../../image/image-20200624180623826.png" alt="image-20200624180623826"></p>
<h5 id="getAdapter"><a href="#getAdapter" class="headerlink" title="getAdapter"></a>getAdapter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the type adapter for &#123;<span class="doctag">@code</span>&#125; type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if this GSON cannot serialize and</span></span><br><span class="line"><span class="comment"> *     deserialize &#123;<span class="doctag">@code</span> type&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">getAdapter</span><span class="params">(TypeToken&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 先看缓存中有无对应的adapter</span></span><br><span class="line">  TypeAdapter&lt;?&gt; cached = typeTokenCache.get(type == <span class="keyword">null</span> ? NULL_KEY_SURROGATE : type);</span><br><span class="line">  <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (TypeAdapter&lt;T&gt;) cached;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FutureTypeAdapter的本地缓存，避免无限递归取adapter</span></span><br><span class="line">  Map&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt; threadCalls = calls.get();</span><br><span class="line">  <span class="keyword">boolean</span> requiresThreadLocalCleanup = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (threadCalls == <span class="keyword">null</span>) &#123;</span><br><span class="line">    threadCalls = <span class="keyword">new</span> HashMap&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt;();</span><br><span class="line">    calls.set(threadCalls);</span><br><span class="line">    requiresThreadLocalCleanup = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the key and value type parameters always agree</span></span><br><span class="line">  <span class="comment">// 如果在FutureTypeAdapter的本地缓存中找到当前类型，表明这个类型的adapter正在创建中</span></span><br><span class="line">  FutureTypeAdapter&lt;T&gt; ongoingCall = (FutureTypeAdapter&lt;T&gt;) threadCalls.get(type);</span><br><span class="line">  <span class="keyword">if</span> (ongoingCall != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ongoingCall;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 放入future的本地缓存</span></span><br><span class="line">    FutureTypeAdapter&lt;T&gt; call = <span class="keyword">new</span> FutureTypeAdapter&lt;T&gt;();</span><br><span class="line">    threadCalls.put(type, call);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历adapter工厂，创建adapter</span></span><br><span class="line">    <span class="comment">// 工厂创建的逻辑是，当前类型不是这个工厂负责的，返回null，反之创意一个adapter实例返回，接下来会讲一个普通类型的工厂、一个复合工厂创建实例的过程</span></span><br><span class="line">    <span class="keyword">for</span> (TypeAdapterFactory factory : factories) &#123;</span><br><span class="line">      TypeAdapter&lt;T&gt; candidate = factory.create(<span class="keyword">this</span>, type);</span><br><span class="line">      <span class="keyword">if</span> (candidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果取到adapter，在FutureTypeAdapter中放入真实adapter</span></span><br><span class="line">        call.setDelegate(candidate);</span><br><span class="line">        typeTokenCache.put(type, candidate);</span><br><span class="line">        <span class="keyword">return</span> candidate;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"GSON ("</span> + GsonBuildConfig.VERSION + <span class="string">") cannot handle "</span> + type);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 从future的本地缓存中移除当前类型</span></span><br><span class="line">    threadCalls.remove(type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (requiresThreadLocalCleanup) &#123;</span><br><span class="line">      calls.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么要有个FutureTypeAdapter的本地缓存呢？</p>
<p>先剧透ReflectiveTypeAdapterFactory在创建adapter的时候，会遍历属性取对应的adapte。比如Person里有个Person属性，就会递归取Person的adapter..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTypeAdapter本质上是个委托者，内部引用了真正的adapter，在执行json读写时会用这个真正的adapter进行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTypeAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 真正的adapter</span></span><br><span class="line">  <span class="keyword">private</span> TypeAdapter&lt;T&gt; delegate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelegate</span><span class="params">(TypeAdapter&lt;T&gt; typeAdapter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">    &#125;</span><br><span class="line">    delegate = typeAdapter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用真正adapter进行读</span></span><br><span class="line">    <span class="keyword">return</span> delegate.read(in);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用真正adapter进行写</span></span><br><span class="line">    delegate.write(out, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="AdapterFactory"><a href="#AdapterFactory" class="headerlink" title="AdapterFactory"></a>AdapterFactory</h5><p>平台基础类型的Adapter是预先定义好的，每个类型对应一个adapter，比如String类型的AdapterFactory返回的adapter永远是<code>TypeAdapters.STRING</code></p>
<p>复合类型和自定义类型（反射类型）的Adapter是需要动态创建的，因为泛型不同、JavaBean的属性不同，等等</p>
<p>接下来看3个实现，其他类型大同小异，理解的思路是一样的</p>
<h6 id="String类型"><a href="#String类型" class="headerlink" title="String类型"></a>String类型</h6><p>STRING_FACTORY和’STRING_ADAPTER’</p>
<p>实际上没有STRING_ADAPTER这个名字，真正名字是STRING</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TypeAdapterFactory是一个只有create方法的工厂，用于创建adapter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeAdapterFactory</span> </span>&#123;</span><br><span class="line">  &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, TypeToken&lt;T&gt; type)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String类型的工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> TypeAdapterFactory STRING_FACTORY = newFactory(String.class, STRING); <span class="comment">// STRING是个adapter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个工厂实例的公共方法...</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;TT&gt; <span class="function">TypeAdapterFactory <span class="title">newFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> Class&lt;TT&gt; type, <span class="keyword">final</span> TypeAdapter&lt;TT&gt; typeAdapter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TypeAdapterFactory() &#123;</span><br><span class="line">      <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// we use a runtime check to make sure the 'T's equal</span></span><br><span class="line">      <span class="meta">@Override</span> <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, TypeToken&lt;T&gt; typeToken)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这一类工厂创建adapter的逻辑是一样的</span></span><br><span class="line">        <span class="comment">// 如果传入的typeToken.getRawType()和预先定义的type是相同的，就返回预先定义的adapter，否则返回null（表示这个rawType不是当前工厂和adapter负责的）</span></span><br><span class="line">        <span class="keyword">return</span> typeToken.getRawType() == type ? (TypeAdapter&lt;T&gt;) typeAdapter : <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Factory[type="</span> + type.getName() + <span class="string">",adapter="</span> + typeAdapter + <span class="string">"]"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String类型的TypeAdapter</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> TypeAdapter&lt;String&gt; STRING = <span class="keyword">new</span> TypeAdapter&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      JsonToken peek = in.peek();</span><br><span class="line">      <span class="comment">// 如果是null</span></span><br><span class="line">      <span class="keyword">if</span> (peek == JsonToken.NULL) &#123;</span><br><span class="line">        in.nextNull();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 某个兼容..先跳过</span></span><br><span class="line">      <span class="comment">/* coerce booleans to strings for backwards compatibility */</span></span><br><span class="line">      <span class="keyword">if</span> (peek == JsonToken.BOOLEAN) &#123;</span><br><span class="line">        <span class="keyword">return</span> Boolean.toString(in.nextBoolean());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 调用JsonReader读json</span></span><br><span class="line">      <span class="keyword">return</span> in.nextString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="comment">// 调用JsonWriter写json</span></span><br><span class="line">      out.value(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>Integer、Long、Boolean、AtomicInteger等等平台基础类型的factory的框架是类似的，或者一样的，有细微的差别（比如同时支持非包装类型和包装类型）</p>
<h6 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h6><p>CollectionTypeAdapterFactory</p>
<p>集合类型的factory和adapter</p>
<p><code>MapTypeAdapterFactory</code>和集合的很类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionTypeAdapterFactory</span> <span class="keyword">implements</span> <span class="title">TypeAdapterFactory</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConstructorConstructor constructorConstructor;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CollectionTypeAdapterFactory</span><span class="params">(ConstructorConstructor constructorConstructor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.constructorConstructor = constructorConstructor;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create在这里</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, TypeToken&lt;T&gt; typeToken)</span> </span>&#123;</span><br><span class="line">    Type type = typeToken.getType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果Collection不是rawType的超类/超接口，那就不是集合工厂来负责</span></span><br><span class="line">    Class&lt;? <span class="keyword">super</span> T&gt; rawType = typeToken.getRawType();</span><br><span class="line">    <span class="keyword">if</span> (!Collection.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取集合元素的类型，这里是带泛型信息的类型</span></span><br><span class="line">    Type elementType = $Gson$Types.getCollectionElementType(type, rawType);</span><br><span class="line">    <span class="comment">// 取元素类型的adapter</span></span><br><span class="line">    TypeAdapter&lt;?&gt; elementTypeAdapter = gson.getAdapter(TypeToken.get(elementType));</span><br><span class="line">    <span class="comment">// 获取构造器，如果没有自定义等等情况，一般是用反射的constructor</span></span><br><span class="line">    ObjectConstructor&lt;T&gt; constructor = constructorConstructor.get(typeToken);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>&#125;) <span class="comment">// create() doesn't define a type parameter</span></span><br><span class="line">    <span class="comment">// 创建一个集合类型的adapter实例</span></span><br><span class="line">    TypeAdapter&lt;T&gt; result = <span class="keyword">new</span> Adapter(gson, elementType, elementTypeAdapter, constructor);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 集合类型的adapter</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">Collection</span>&lt;<span class="title">E</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 集合元素的adapter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;E&gt; elementTypeAdapter;</span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectConstructor&lt;? extends Collection&lt;E&gt;&gt; constructor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Adapter</span><span class="params">(Gson context, Type elementType,</span></span></span><br><span class="line"><span class="function"><span class="params">        TypeAdapter&lt;E&gt; elementTypeAdapter,</span></span></span><br><span class="line"><span class="function"><span class="params">        ObjectConstructor&lt;? extends Collection&lt;E&gt;&gt; constructor)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 这里元素adapter还有一个封装，会在writeJson时取运行时的Type，毕竟运行时的最准确（比如定义时候是List&lt;? extends Cat&gt;，运行时实际放入的是Cat接口的一个实现WhiteCat），再根据运行时Type取相应adapter...</span></span><br><span class="line">      <span class="keyword">this</span>.elementTypeAdapter =</span><br><span class="line">          <span class="keyword">new</span> TypeAdapterRuntimeTypeWrapper&lt;E&gt;(context, elementTypeAdapter, elementType);</span><br><span class="line">      <span class="keyword">this</span>.constructor = constructor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读json</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Collection&lt;E&gt; <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (in.peek() == JsonToken.NULL) &#123;</span><br><span class="line">        in.nextNull();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Collection&lt;E&gt; collection = constructor.construct();</span><br><span class="line">      <span class="comment">// 读入 [</span></span><br><span class="line">      in.beginArray();</span><br><span class="line">      <span class="keyword">while</span> (in.hasNext()) &#123;</span><br><span class="line">        <span class="comment">// 委托元素adapter读每个元素</span></span><br><span class="line">        E instance = elementTypeAdapter.read(in);</span><br><span class="line">        <span class="comment">// 元素放入集合</span></span><br><span class="line">        collection.add(instance);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 读入 ]</span></span><br><span class="line">      in.endArray();</span><br><span class="line">      <span class="keyword">return</span> collection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, Collection&lt;E&gt; collection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (collection == <span class="keyword">null</span>) &#123;</span><br><span class="line">        out.nullValue();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 写 ]</span></span><br><span class="line">      out.beginArray();</span><br><span class="line">      <span class="keyword">for</span> (E element : collection) &#123;</span><br><span class="line">        <span class="comment">// 写每个元素</span></span><br><span class="line">        elementTypeAdapter.write(out, element);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 写 ]</span></span><br><span class="line">      out.endArray();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TypeAdapterRuntimeTypeWrapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 优先级 运行时类型adapter（最高） &gt; 声明类型adapter &gt; 运行时类型reflective adapter &gt; 声明类型reflective adapter</span></span><br><span class="line">  <span class="comment">// Order of preference for choosing type adapters</span></span><br><span class="line">  <span class="comment">// First preference: a type adapter registered for the runtime type</span></span><br><span class="line">  <span class="comment">// Second preference: a type adapter registered for the declared type</span></span><br><span class="line">  <span class="comment">// Third preference: reflective type adapter for the runtime type (if it is a sub class of the declared type)</span></span><br><span class="line">  <span class="comment">// Fourth preference: reflective type adapter for the declared type</span></span><br><span class="line"></span><br><span class="line">  TypeAdapter chosen = delegate;</span><br><span class="line">  <span class="comment">// 运行时Type</span></span><br><span class="line">  Type runtimeType = getRuntimeTypeIfMoreSpecific(type, value);</span><br><span class="line">  <span class="comment">// 如果runtimeType和传入的Type（即用户声明的对象的Type）不一样</span></span><br><span class="line">  <span class="keyword">if</span> (runtimeType != type) &#123;</span><br><span class="line">    TypeAdapter runtimeTypeAdapter = context.getAdapter(TypeToken.get(runtimeType));</span><br><span class="line">    <span class="keyword">if</span> (!(runtimeTypeAdapter <span class="keyword">instanceof</span> ReflectiveTypeAdapterFactory.Adapter)) &#123;</span><br><span class="line">      <span class="comment">// The user registered a type adapter for the runtime type, so we will use that</span></span><br><span class="line">      <span class="comment">// ReflectiveTypeAdapterFactory是注册的最后一个factory</span></span><br><span class="line">      <span class="comment">// 如果运行时TypeAdapter不是最后一种Adapter</span></span><br><span class="line">      chosen = runtimeTypeAdapter;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(delegate <span class="keyword">instanceof</span> ReflectiveTypeAdapterFactory.Adapter)) &#123;</span><br><span class="line">      <span class="comment">// The user registered a type adapter for Base class, so we prefer it over the</span></span><br><span class="line">      <span class="comment">// reflective type adapter for the runtime type</span></span><br><span class="line">      <span class="comment">// （delegate是根据用户声明的类型找到的）如果delegate也不是最后一种，用delegate</span></span><br><span class="line">      chosen = delegate;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Use the type adapter for runtime type</span></span><br><span class="line">      chosen = runtimeTypeAdapter;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  chosen.write(out, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="反射类型"><a href="#反射类型" class="headerlink" title="反射类型"></a>反射类型</h6><p>ReflectiveTypeAdapterFactory，可以理解为用户自定义的JavaBean对应的Factory。</p>
<p>这是一个通过遍历对象中的属性来进行序列化的adapter。</p>
<p>接口、或者抽象类，不能反序列化（因为不能实例化）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Type adapter that reflects over the fields and methods of a class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectiveTypeAdapterFactory</span> <span class="keyword">implements</span> <span class="title">TypeAdapterFactory</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConstructorConstructor constructorConstructor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FieldNamingStrategy fieldNamingPolicy;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Excluder excluder;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> JsonAdapterAnnotationTypeAdapterFactory jsonAdapterFactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReflectionAccessor accessor = ReflectionAccessor.getInstance();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先看构造器</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReflectiveTypeAdapterFactory</span><span class="params">(ConstructorConstructor constructorConstructor,</span></span></span><br><span class="line"><span class="function"><span class="params">      FieldNamingStrategy fieldNamingPolicy, Excluder excluder,</span></span></span><br><span class="line"><span class="function"><span class="params">      JsonAdapterAnnotationTypeAdapterFactory jsonAdapterFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.constructorConstructor = constructorConstructor;</span><br><span class="line">    <span class="keyword">this</span>.fieldNamingPolicy = fieldNamingPolicy;</span><br><span class="line">    <span class="keyword">this</span>.excluder = excluder;</span><br><span class="line">    <span class="keyword">this</span>.jsonAdapterFactory = jsonAdapterFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">excludeField</span><span class="params">(Field f, <span class="keyword">boolean</span> serialize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> excludeField(f, serialize, excluder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">excludeField</span><span class="params">(Field f, <span class="keyword">boolean</span> serialize, Excluder excluder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !excluder.excludeClass(f.getType(), serialize) &amp;&amp; !excluder.excludeField(f, serialize);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** first element holds the default name */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getFieldNames</span><span class="params">(Field f)</span> </span>&#123;</span><br><span class="line">    SerializedName annotation = f.getAnnotation(SerializedName.class);</span><br><span class="line">    <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">      String name = fieldNamingPolicy.translateName(f);</span><br><span class="line">      <span class="keyword">return</span> Collections.singletonList(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String serializedName = annotation.value();</span><br><span class="line">    String[] alternates = annotation.alternate();</span><br><span class="line">    <span class="keyword">if</span> (alternates.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Collections.singletonList(serializedName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; fieldNames = <span class="keyword">new</span> ArrayList&lt;String&gt;(alternates.length + <span class="number">1</span>);</span><br><span class="line">    fieldNames.add(serializedName);</span><br><span class="line">    <span class="keyword">for</span> (String alternate : alternates) &#123;</span><br><span class="line">      fieldNames.add(alternate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fieldNames;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, <span class="keyword">final</span> TypeToken&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    Class&lt;? <span class="keyword">super</span> T&gt; raw = type.getRawType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为Object是所有类的父类，所以这个Factory可以适配任意类型</span></span><br><span class="line">    <span class="keyword">if</span> (!Object.class.isAssignableFrom(raw)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// it's a primitive!</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ObjectConstructor&lt;T&gt; constructor = constructorConstructor.get(type);</span><br><span class="line">    <span class="comment">// 构造一个adapter实例，getBoundFields封装了类中的属性，继续往里看</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Adapter&lt;T&gt;(constructor, getBoundFields(gson, type, raw));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装Field</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Map&lt;String, BoundField&gt; <span class="title">getBoundFields</span><span class="params">(Gson context, TypeToken&lt;?&gt; type, Class&lt;?&gt; raw)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, BoundField&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;String, BoundField&gt;();</span><br><span class="line">    <span class="comment">// 如果是接口，就没有Field，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (raw.isInterface()) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Type declaredType = type.getType();</span><br><span class="line">    <span class="keyword">while</span> (raw != Object.class) &#123;</span><br><span class="line">      <span class="comment">// 当前类声明的属性</span></span><br><span class="line">      Field[] fields = raw.getDeclaredFields();</span><br><span class="line">      <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">        <span class="comment">// 判断这个属性是否进行序列化和反序列化</span></span><br><span class="line">        <span class="keyword">boolean</span> serialize = excludeField(field, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">boolean</span> deserialize = excludeField(field, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 如果序列化和反序列都不需要，跳过</span></span><br><span class="line">        <span class="keyword">if</span> (!serialize &amp;&amp; !deserialize) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        accessor.makeAccessible(field);</span><br><span class="line">        <span class="comment">// 取属性的带泛型信息的Type</span></span><br><span class="line">        Type fieldType = $Gson$Types.resolve(type.getType(), raw, field.getGenericType());</span><br><span class="line">        <span class="comment">// 获取属性对应的序列化名称</span></span><br><span class="line">        <span class="comment">// 如果没有@SerializedName注解，就取Field的name，再根据fieldNamingPolicy策略做下转换，比如全驼峰、驼峰带空格等</span></span><br><span class="line">        <span class="comment">// 如果有注解，用注解里定义的name和其他备选</span></span><br><span class="line">        <span class="comment">// fieldNames里的第一个是默认name</span></span><br><span class="line">        List&lt;String&gt; fieldNames = getFieldNames(field);</span><br><span class="line">        <span class="comment">// previous是用来判断，是否有两个field的name重复了</span></span><br><span class="line">        BoundField previous = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = fieldNames.size(); i &lt; size; ++i) &#123;</span><br><span class="line">          String name = fieldNames.get(i);</span><br><span class="line">          <span class="keyword">if</span> (i != <span class="number">0</span>) serialize = <span class="keyword">false</span>; <span class="comment">// only serialize the default name 序列化的时候只序列化第一个name，反序列时可以通过其他的备选name来反序列化</span></span><br><span class="line">          <span class="comment">// 封装field</span></span><br><span class="line">          BoundField boundField = createBoundField(context, field, name,</span><br><span class="line">              TypeToken.get(fieldType), serialize, deserialize);</span><br><span class="line">          <span class="comment">// 放进result（不允许存在相同name的boundField，如果有相同name，反序列时就不知道该把value赋值给哪个属性了）</span></span><br><span class="line">          BoundField replaced = result.put(name, boundField);</span><br><span class="line">          <span class="keyword">if</span> (previous == <span class="keyword">null</span>) previous = replaced;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果name重复，抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(declaredType</span><br><span class="line">              + <span class="string">" declares multiple JSON fields named "</span> + previous.name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 向上递归父类</span></span><br><span class="line">      type = TypeToken.get($Gson$Types.resolve(type.getType(), raw, raw.getGenericSuperclass()));</span><br><span class="line">      raw = type.getRawType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装field，本质上是每个Field的adapter</span></span><br><span class="line">  <span class="keyword">private</span> ReflectiveTypeAdapterFactory.<span class="function">BoundField <span class="title">createBoundField</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> Gson context, <span class="keyword">final</span> Field field, <span class="keyword">final</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> TypeToken&lt;?&gt; fieldType, <span class="keyword">boolean</span> serialize, <span class="keyword">boolean</span> deserialize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isPrimitive = Primitives.isPrimitive(fieldType.getRawType());</span><br><span class="line">    <span class="comment">// special casing primitives here saves ~5% on Android</span></span><br><span class="line">    <span class="comment">// 如果在属性上有@JsonAdapter注解，指定了adapter，用这个adapter（优先级最高）</span></span><br><span class="line">    JsonAdapter annotation = field.getAnnotation(JsonAdapter.class);</span><br><span class="line">    TypeAdapter&lt;?&gt; mapped = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">      mapped = jsonAdapterFactory.getTypeAdapter(</span><br><span class="line">          constructorConstructor, context, fieldType, annotation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jsonAdapterPresent = mapped != <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 如果未指定，用属性的Type找adapter</span></span><br><span class="line">    <span class="keyword">if</span> (mapped == <span class="keyword">null</span>) mapped = context.getAdapter(fieldType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TypeAdapter&lt;?&gt; typeAdapter = mapped;</span><br><span class="line">    <span class="comment">// 返回封装的Field</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveTypeAdapterFactory.BoundField(name, serialize, deserialize) &#123;</span><br><span class="line">      <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>&#125;) <span class="comment">// the type adapter and field type always agree</span></span><br><span class="line">      <span class="comment">// 写json</span></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter writer, Object value)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException, IllegalAccessException </span>&#123;</span><br><span class="line">        Object fieldValue = field.get(value);</span><br><span class="line">        <span class="comment">// 如果有指定adapter，直接用指定的，否则要再检查一下运行时的精确Type</span></span><br><span class="line">        TypeAdapter t = jsonAdapterPresent ? typeAdapter</span><br><span class="line">            : <span class="keyword">new</span> TypeAdapterRuntimeTypeWrapper(context, typeAdapter, fieldType.getType());</span><br><span class="line">        t.write(writer, fieldValue);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 读json</span></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(JsonReader reader, Object value)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="comment">// 不论是指定的，还是声明的type取到的adapter，直接读</span></span><br><span class="line">        Object fieldValue = typeAdapter.read(reader);</span><br><span class="line">        <span class="keyword">if</span> (fieldValue != <span class="keyword">null</span> || !isPrimitive) &#123;</span><br><span class="line">          field.set(value, fieldValue);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeField</span><span class="params">(Object value)</span> <span class="keyword">throws</span> IOException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!serialized) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Object fieldValue = field.get(value);</span><br><span class="line">        <span class="keyword">return</span> fieldValue != value; <span class="comment">// avoid recursion for example for Throwable.cause</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义的抽象类，Field的封装，上面看过了</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BoundField</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> serialized;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> deserialized;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">BoundField</span><span class="params">(String name, <span class="keyword">boolean</span> serialized, <span class="keyword">boolean</span> deserialized)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.name = name;</span><br><span class="line">      <span class="keyword">this</span>.serialized = serialized;</span><br><span class="line">      <span class="keyword">this</span>.deserialized = deserialized;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">writeField</span><span class="params">(Object value)</span> <span class="keyword">throws</span> IOException, IllegalAccessException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter writer, Object value)</span> <span class="keyword">throws</span> IOException, IllegalAccessException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(JsonReader reader, Object value)</span> <span class="keyword">throws</span> IOException, IllegalAccessException</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 属性的adapter封装看完了，到对象的adapter了</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectConstructor&lt;T&gt; constructor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BoundField&gt; boundFields;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 持有构造器和属性</span></span><br><span class="line">    Adapter(ObjectConstructor&lt;T&gt; constructor, Map&lt;String, BoundField&gt; boundFields) &#123;</span><br><span class="line">      <span class="keyword">this</span>.constructor = constructor;</span><br><span class="line">      <span class="keyword">this</span>.boundFields = boundFields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读json</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="comment">// 空对象</span></span><br><span class="line">      <span class="keyword">if</span> (in.peek() == JsonToken.NULL) &#123;</span><br><span class="line">        in.nextNull();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构造器make一个实例</span></span><br><span class="line">      T instance = constructor.construct();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读对象开始 &#123;</span></span><br><span class="line">        in.beginObject();</span><br><span class="line">        <span class="keyword">while</span> (in.hasNext()) &#123;</span><br><span class="line">          <span class="comment">// 读一个名称</span></span><br><span class="line">          String name = in.nextName();</span><br><span class="line">          <span class="comment">// 取对应field封装</span></span><br><span class="line">          BoundField field = boundFields.get(name);</span><br><span class="line">          <span class="comment">// 如果field找不到，或不需要反序列化，则跳过</span></span><br><span class="line">          <span class="keyword">if</span> (field == <span class="keyword">null</span> || !field.deserialized) &#123;</span><br><span class="line">            in.skipValue();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 委托filed封装读入value</span></span><br><span class="line">            <span class="comment">// 如果定义的field是个List&lt;String&gt; list的话，实际上是会委托到集合Adapter去操作的，集合Adapter又会委托到集合元素的Adapter...就是这么一层层递归下去的，直到递归到平台基本类型的Adapter，执行基础的read和write</span></span><br><span class="line">            field.read(in, instance);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(e);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 读对象结束 &#125;</span></span><br><span class="line">      in.endObject();</span><br><span class="line">      <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写json</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        out.nullValue();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 写 &#123;</span></span><br><span class="line">      out.beginObject();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 委托每个属性adapter写name和value</span></span><br><span class="line">        <span class="keyword">for</span> (BoundField boundField : boundFields.values()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (boundField.writeField(value)) &#123;</span><br><span class="line">            out.name(boundField.name);</span><br><span class="line">            boundField.write(out, value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 写 &#125;</span></span><br><span class="line">      out.endObject();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>源码差不多就到这里了，还有很多Gson的细节、以及扩展性的地方，就不在这里深入讨论了。</p>
<p>捋一下大体流程</p>
<ol>
<li>根据对象的Type，由Factory创建adapter</li>
<li>创建adapter的过程中，会递归对内部属性创建adapter – 可选，不同Type逻辑不同</li>
<li>委托adapter读写json</li>
</ol>
<p>源码中比较难看懂的是有很多工厂类、委托类，如果能理清大体的逻辑，就比较容易触类旁通了。</p>
<p>to be continued…</p>
<p>Jackson</p>
<p>FastJson </p>
<p>其他序列化</p>
<h1 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h1><p>比较简单粗暴地对比..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerformanceComparison</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPerformance</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        stopWatch.start(<span class="string">"mock list"</span>);</span><br><span class="line">        List&lt;People&gt; peoples = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">int</span> cnt = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">            People people = <span class="keyword">new</span> People();</span><br><span class="line">            people.setAge(i);</span><br><span class="line">            people.setName(<span class="string">"lily"</span> + i);</span><br><span class="line">            people.setNicknames(Lists.newArrayList(<span class="string">"nick1-"</span> + i, <span class="string">"nick2-"</span> + i));</span><br><span class="line">            People friend = <span class="keyword">new</span> People();</span><br><span class="line">            friend.setName(<span class="string">"friend"</span>);</span><br><span class="line">            people.setFriends(Maps.newHashMap(<span class="string">"friend"</span>, friend));</span><br><span class="line">            peoples.add(people);</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        stopWatch.start(<span class="string">"print"</span>);</span><br><span class="line">        log.info(<span class="string">"peoples = &#123;&#125;"</span>, peoples);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line"></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        stopWatch.start(<span class="string">"gson toJson"</span>);</span><br><span class="line">        String json = gson.toJson(peoples);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        log.info(<span class="string">"gson toJson = &#123;&#125;"</span>, json);</span><br><span class="line"></span><br><span class="line">        stopWatch.start(<span class="string">"serialization "</span>);</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"performance.txt"</span>));</span><br><span class="line">        outputStream.writeObject(peoples);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        log.info(<span class="string">"\n&#123;&#125;"</span>, stopWatch.prettyPrint());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">16:19:56.483 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - </span><br><span class="line">cnt = 10</span><br><span class="line">StopWatch '': running time = 26069677 ns</span><br><span class="line">---------------------------------------------</span><br><span class="line">ns         %     Task name</span><br><span class="line">---------------------------------------------</span><br><span class="line">002320593  009%  mock list</span><br><span class="line">006721048  026%  gson toJson</span><br><span class="line">017028036  065%  serialization </span><br><span class="line"></span><br><span class="line">16:19:56.521 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - </span><br><span class="line">cnt = 100</span><br><span class="line">StopWatch '': running time = 32385670 ns</span><br><span class="line">---------------------------------------------</span><br><span class="line">ns         %     Task name</span><br><span class="line">---------------------------------------------</span><br><span class="line">000322435  001%  mock list</span><br><span class="line">016472014  051%  gson toJson</span><br><span class="line">015591221  048%  serialization </span><br><span class="line"></span><br><span class="line">16:19:56.611 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - </span><br><span class="line">cnt = 1000</span><br><span class="line">StopWatch '': running time = 89620834 ns</span><br><span class="line">---------------------------------------------</span><br><span class="line">ns         %     Task name</span><br><span class="line">---------------------------------------------</span><br><span class="line">001630599  002%  mock list</span><br><span class="line">022239885  025%  gson toJson</span><br><span class="line">065750350  073%  serialization </span><br><span class="line"></span><br><span class="line">16:19:57.315 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - </span><br><span class="line">cnt = 10000</span><br><span class="line">StopWatch '': running time = 703038881 ns</span><br><span class="line">---------------------------------------------</span><br><span class="line">ns         %     Task name</span><br><span class="line">---------------------------------------------</span><br><span class="line">005390392  001%  mock list</span><br><span class="line">033934519  005%  gson toJson</span><br><span class="line">663713970  094%  serialization </span><br><span class="line"></span><br><span class="line">16:20:03.333 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - </span><br><span class="line">cnt = 100000</span><br><span class="line">StopWatch '': running time = 6017844063 ns</span><br><span class="line">---------------------------------------------</span><br><span class="line">ns         %     Task name</span><br><span class="line">---------------------------------------------</span><br><span class="line">074621832  001%  mock list</span><br><span class="line">181025115  003%  gson toJson</span><br><span class="line">5762197116  096%  serialization</span><br></pre></td></tr></table></figure>
<p>10次的平均：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">16:36:16.309 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - cnt = 10</span><br><span class="line">16:36:16.316 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - gson = 6ms</span><br><span class="line">16:36:16.316 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - serial = 3ms</span><br><span class="line">16:36:16.406 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - cnt = 100</span><br><span class="line">16:36:16.406 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - gson = 1ms</span><br><span class="line">16:36:16.406 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - serial = 7ms</span><br><span class="line">16:36:17.025 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - cnt = 1000</span><br><span class="line">16:36:17.026 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - gson = 3ms</span><br><span class="line">16:36:17.026 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - serial = 58ms</span><br><span class="line">16:36:21.700 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - cnt = 10000</span><br><span class="line">16:36:21.701 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - gson = 16ms</span><br><span class="line">16:36:21.701 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - serial = 450ms</span><br><span class="line">16:37:14.224 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - cnt = 100000</span><br><span class="line">16:37:14.224 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - gson = 122ms</span><br><span class="line">16:37:14.224 [main] INFO wyq.learning.quickstart.serialization.PerformanceComparison - serial = 5123ms</span><br></pre></td></tr></table></figure>
<p>可以看出来，个数越多，性能差异越明显。</p>
<h1 id="Mock小工具"><a href="#Mock小工具" class="headerlink" title="Mock小工具"></a>Mock小工具</h1><p>仿Gson反序列化的逻辑，比较简单的Mock工具，可以支持常见的JavaBean的对象Mock，省去一一手工创建对象、赋值的麻烦。</p>
<p>ps如果对数值有要求，还是要后续自己赋值的。这个小工具的初衷是ut测试时，程序中对属性有非空校验。</p>
<p>pps暂未实现全部的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, TT&gt; <span class="function">T <span class="title">mockOf</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">        Class&lt;? <span class="keyword">super</span> T&gt; rawType = (Class&lt;? <span class="keyword">super</span> T&gt;) getRawType(type);</span><br><span class="line">        Object object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (rawType == String.class) &#123;</span><br><span class="line">            object = <span class="string">"mock"</span> + RandomUtils.nextInt();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawType == Long.class || rawType == <span class="keyword">long</span>.class) &#123;</span><br><span class="line">            object = RandomUtils.nextLong();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawType == Integer.class || rawType == <span class="keyword">int</span>.class) &#123;</span><br><span class="line">            object = RandomUtils.nextInt();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawType == BigDecimal.class) &#123;</span><br><span class="line">            object = BigDecimal.valueOf(RandomUtils.nextFloat()).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawType == Date.class) &#123;</span><br><span class="line">            object = <span class="keyword">new</span> Date();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType || type <span class="keyword">instanceof</span> Class &amp;&amp; ((Class) type).isArray()) &#123;</span><br><span class="line">            Type componentType = type <span class="keyword">instanceof</span> GenericArrayType ? ((GenericArrayType) type).getGenericComponentType() : ((Class) type).getComponentType();</span><br><span class="line">            <span class="keyword">if</span> (componentType == type) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;TT&gt; rawComponentType = (Class&lt;TT&gt;) getRawType(componentType);</span><br><span class="line">            List&lt;TT&gt; list = <span class="keyword">new</span> ArrayList&lt;TT&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, num = RandomUtils.nextInt(<span class="number">1</span>, <span class="number">5</span>); i &lt; num; i++) &#123;</span><br><span class="line">                TT instance = mockOf(rawComponentType);</span><br><span class="line">                list.add(instance);</span><br><span class="line">            &#125;</span><br><span class="line">            Object array = Array.newInstance(rawComponentType, list.size());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">                Array.set(array, i, list.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            object = array;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Collection.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">            Type elementType = type <span class="keyword">instanceof</span> ParameterizedType ? ((ParameterizedType) type).getActualTypeArguments()[<span class="number">0</span>] : Object.class;</span><br><span class="line">            <span class="keyword">if</span> (elementType == type) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Collection&lt;TT&gt; collection = construct(rawType);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = RandomUtils.nextInt(<span class="number">1</span>, <span class="number">5</span>); i &lt; size; i++) &#123;</span><br><span class="line">                collection.add(mockOf((Class&lt;TT&gt;) elementType));</span><br><span class="line">            &#125;</span><br><span class="line">            object = collection;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">            log.info(<span class="string">"map ignored"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Object.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                T t = (T) rawType.getDeclaredConstructor().newInstance();</span><br><span class="line">                Field[] fields = rawType.getDeclaredFields();</span><br><span class="line">                <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                    Type fieldType = field.getGenericType();</span><br><span class="line">                    <span class="keyword">if</span> (fieldType <span class="keyword">instanceof</span> ParameterizedType &amp;&amp; ((ParameterizedType) fieldType).getActualTypeArguments()[<span class="number">0</span>] == type) &#123;</span><br><span class="line">                        log.info(<span class="string">"cycle ignored"</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    TT value = mockOf(fieldType);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, value);</span><br><span class="line">                &#125;</span><br><span class="line">                object = t;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException | InvocationTargetException | NoSuchMethodException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">construct</span><span class="params">(Class&lt;? <span class="keyword">super</span> T&gt; rawType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Collection.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SortedSet.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) <span class="keyword">new</span> TreeSet&lt;Object&gt;();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Set.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) <span class="keyword">new</span> LinkedHashSet&lt;Object&gt;();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Queue.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) <span class="keyword">new</span> ArrayDeque&lt;Object&gt;();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Map.class.isAssignableFrom(rawType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> LinkedHashMap&lt;Object, Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Product product = SimpleMock.mockOf(Product.class);</span><br><span class="line">        log.info(<span class="string">"product = &#123;&#125;"</span>, gson.toJson(product));</span><br><span class="line"></span><br><span class="line">        List&lt;Product&gt; products = SimpleMock.mockOf(<span class="keyword">new</span> TypeToken&lt;List&lt;Product&gt;&gt;() &#123;</span><br><span class="line">        &#125;.getType());</span><br><span class="line">        log.info(<span class="string">"products = &#123;&#125;"</span>, gson.toJson(products));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Long id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; list;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Product&gt; products;</span><br><span class="line">        <span class="keyword">private</span> Integer[] integers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><p><a href="https://juejin.im/post/5ce3cdc8e51d45777b1a3cdf#heading-8" target="_blank" rel="noopener">Java序列化</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/binarylei/category/1159503.html" target="_blank" rel="noopener">Java 序列化和反序列化的几篇文章</a></p>
</li>
<li><a href="https://juejin.im/post/5c1473d9e51d4529ee23645f" target="_blank" rel="noopener">Gson源码解析和它的设计模式</a></li>
</ol>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2020/07/04/算法汇总/" class="pre">算法汇总</a><a href="/2020/06/19/JVM的几个大知识点/" class="next">JVM的几个大知识点</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#序列化工具"><span class="toc-text">序列化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java序列化"><span class="toc-text">Java序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基础用法"><span class="toc-text">基础用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义用法"><span class="toc-text">自定义用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他知识点"><span class="toc-text">其他知识点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现原理"><span class="toc-text">实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#接口关系"><span class="toc-text">接口关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ObjectOutputStream源码分析"><span class="toc-text">ObjectOutputStream源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectOutputStream-数据结构"><span class="toc-text">ObjectOutputStream 数据结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectOutputStream-构造函数"><span class="toc-text">ObjectOutputStream 构造函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#序列化入口-writeObject"><span class="toc-text">序列化入口 writeObject</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-writeObject"><span class="toc-text">1. writeObject</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-writeObject0"><span class="toc-text">2. writeObject0</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-writeString-amp-writeArray-amp-writeEnum"><span class="toc-text">2.1 writeString&amp;writeArray&amp;writeEnum</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-writeOrdinaryObject"><span class="toc-text">2.2 writeOrdinaryObject</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1-writeClassDesc"><span class="toc-text">2.2.1 writeClassDesc</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-writeSerailData"><span class="toc-text">2.2.2 writeSerailData</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-1-defaultWriteFields"><span class="toc-text">2.2.2.1 defaultWriteFields</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他知识点-1"><span class="toc-text">其他知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#字段值的读取和写入"><span class="toc-text">字段值的读取和写入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#共享句柄"><span class="toc-text">共享句柄</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一个直观的例子"><span class="toc-text">一个直观的例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gson"><span class="toc-text">Gson</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-1"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基础用法-1"><span class="toc-text">基础用法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#基本类型"><span class="toc-text">基本类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#引用类型"><span class="toc-text">引用类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#数组"><span class="toc-text">数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#泛型"><span class="toc-text">泛型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现原理-1"><span class="toc-text">实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#核心：TypeAdapter"><span class="toc-text">核心：TypeAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源码分析"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Gson属性和构造函数"><span class="toc-text">Gson属性和构造函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#toJson"><span class="toc-text">toJson</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getAdapter"><span class="toc-text">getAdapter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AdapterFactory"><span class="toc-text">AdapterFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#String类型"><span class="toc-text">String类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#集合类型"><span class="toc-text">集合类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#反射类型"><span class="toc-text">反射类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#性能对比"><span class="toc-text">性能对比</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mock小工具"><span class="toc-text">Mock小工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/11/10/国际-国内行业分析统计/">国际&国内行业分析统计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/10/Java-Lambda的实现原理/">Java-Lambda的实现原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/10/Java动态代理/">Java动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/06/关于中台/">关于中台</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/05/国内外大厂发展史/">国内外大厂发展史</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/04/如何构建笔记系统/">如何构建笔记系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/04/如何阅读一本书/">如何阅读一本书</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/03/广告行业入门/">广告行业入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/26/技术栈Notes/">技术栈Notes</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/22/Learning-English/">Learning English</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/INBOX/">INBOX</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/KNOWLEDGE/">KNOWLEDGE</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetCode/">leetCode</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/netty/">netty</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/netty/java-nio/">java nio</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构学习/">架构学习</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码解析/">源码解析</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/源码解析/设计模式/">设计模式</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题排查/">问题排查</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/lambda/" style="font-size: 15px;">lambda</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/循序渐进linux/" style="font-size: 15px;">循序渐进linux</a> <a href="/tags/leetCode/" style="font-size: 15px;">leetCode</a> <a href="/tags/COLA/" style="font-size: 15px;">COLA</a> <a href="/tags/深入理解Java虚拟机/" style="font-size: 15px;">深入理解Java虚拟机</a> <a href="/tags/Java并发/" style="font-size: 15px;">Java并发</a> <a href="/tags/INBOX/" style="font-size: 15px;">INBOX</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Lambda/" style="font-size: 15px;">Lambda</a> <a href="/tags/KNOWLEDGE/" style="font-size: 15px;">KNOWLEDGE</a> <a href="/tags/动态代理/" style="font-size: 15px;">动态代理</a> <a href="/tags/OKHttp/" style="font-size: 15px;">OKHttp</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/PropertyPlaceholderConfigurer/" style="font-size: 15px;">PropertyPlaceholderConfigurer</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/nio/" style="font-size: 15px;">nio</a> <a href="/tags/netty/" style="font-size: 15px;">netty</a> <a href="/tags/通信/" style="font-size: 15px;">通信</a> <a href="/tags/springmvc/" style="font-size: 15px;">springmvc</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a> <a href="/tags/ExceptionHandler/" style="font-size: 15px;">ExceptionHandler</a> <a href="/tags/ResponseBody/" style="font-size: 15px;">ResponseBody</a> <a href="/tags/swagger/" style="font-size: 15px;">swagger</a> <a href="/tags/剑指offer/" style="font-size: 15px;">剑指offer</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/广告行业/" style="font-size: 15px;">广告行业</a> <a href="/tags/消息中间件/" style="font-size: 15px;">消息中间件</a> <a href="/tags/Gson/" style="font-size: 15px;">Gson</a> <a href="/tags/Java虚拟机/" style="font-size: 15px;">Java虚拟机</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 15px;">ConcurrentHashMap</a> <a href="/tags/Java容器/" style="font-size: 15px;">Java容器</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Linjingyu.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>