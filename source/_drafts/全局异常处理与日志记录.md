---
title: 全局异常处理与日志记录
tags:
  - 全局异常处理
  - 全局日志记录
categories:
  - 工程实践
date: 2020-02-27 16:05:35
---

[toc]

为了给调用方比较友好的错误提示，我们会尽量捕获异常，转换为约定的通用格式，比如DailiSoaResult、JsonCommonResponse等等。

另一方面，为了方便问题排查，会尽量多地输出日志，记录出入参，也是不小工作量，偶尔也会遗忘，或是增加修改成本（比如重命名等）。

这里介绍一些全局的处理方式，省去在每个方法里try catch和log，解放劳动力。

当然，全局的处理方式还有很多，可以灵活搭配使用，这里仅作抛砖引玉。更多原理理解，可以看文尾的参考链接。



# 全局异常处理

## web层

spring中的全局异常处理，主要有三种：

1. 注解`@ExceptionHandler`
2. 实现`HandlerExceptionResolver`接口
3. 注解`@ControllerAdvice` -- **推荐使用**



### 注解`@ExceptionHandler`

在controller的方法上使用。有多个controller的话，可以在BaseController中实现ExceptionHandler的处理，其他controller继承BaseController以共享这个异常处理。

优点：简单

缺点：继承的方式不友好



目前代理工程中web大部分有BaseController，就直接使用这种方式了。需要说明的是，项目中有比较复杂的配置，导致`@ExceptionHandler`方法的`@ResponseBody`注解失效，会序列化为xml结果，所以在方法内用Gson直接序列化输出。

简单原理说明：tbd

代码示例：

```java
@RestController
public class UserController {

    @GetMapping("/user/get")
    public User get() {
        return User.builder().name("lily").age(11).build();
    }

    @GetMapping("/user/error")
    public User error() {
        throw new RuntimeException("system error");
    }

    @GetMapping("/user/illegal")
    public User illegal() {
        throw new IllegalArgumentException("no parameter");
    }
    
    @ExceptionHandler(Throwable.class)
    public Map<String, Object> exceptionHandler(Throwable t) {
        Map<String, Object> result = Maps.newHashMap();
        if (t instanceof IllegalArgumentException) {
            // 可以输出自定义的异常信息
            result.put("2", t.getMessage());
        } else {
            // 也可以输出统一的异常信息
            result.put("1", "系统异常");
        }
        return result;
    }
}
```




### 注解`@ControllerAdvice`

实际上是与`@ExceptionHandler`搭配使用。

`@ControllerAdvice`是一个特殊的`@Component`，被注解的类中的`@ExceptionHandler`，`@InitBinder`，`@ModelAttribute`方法将作用于所有的`@Controller`类的接口上。

也就解决了需要继承BaseController的问题。

简单原理说明：tbd

代码示例：

```java
@ControllerAdvice
@RestController
public class UserControllerAdvice {
    @ExceptionHandler(Throwable.class)
//    @ResponseBody和@RestController都可以
    public Map<String, Object> exceptionHandler(Throwable t) {
        Map<String, Object> result = Maps.newHashMap();
        if (t instanceof IllegalArgumentException) {
            // 可以输出自定义的异常信息
            result.put("2", t.getMessage());
        } else {
            // 也可以输出统一的异常信息
            result.put("1", "系统异常");
        }
        return result;
    }
}
```





## soa层





# 全局日志记录



# 操作日志





# 参考链接

1. [深入理解 Spring 异常处理](https://www.infoq.cn/article/x-XFMSsN8IrDO2YR0T82)
2. [Spring进阶之@ControllerAdvice与统一异常处理](https://juejin.im/post/5cb95001e51d456e63760476)
